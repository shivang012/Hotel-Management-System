{% extends 'base.html' %}
{% block content %}
<div class="page-header fade-in">
  <div>
    <h1><i class="fas fa-users"></i> Guest Management</h1>
    <p class="page-description">Manage guest information, contacts, and profiles</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" onclick="showAddGuestForm()">
      <i class="fas fa-plus"></i> Add Guest
    </button>
  </div>
</div>

<div class="table-container slide-up">
  <div class="table-header">
    <h2><i class="fas fa-list"></i> All Guests</h2>
    <div class="table-filters">
      <input type="text" id="searchFilter" placeholder="Search guests..." onkeyup="filterGuests()">
    </div>
  </div>
  <table class="data-table" id="guestsTable">
    <thead>
      <tr>
        <th><i class="fas fa-user"></i> Name</th>
        <th><i class="fas fa-envelope"></i> Email</th>
        <th><i class="fas fa-phone"></i> Phone</th>
        <th><i class="fas fa-map-marker-alt"></i> Address</th>
        <th><i class="fas fa-cogs"></i> Actions</th>
      </tr>
    </thead>
    <tbody id="guestsBody">
      <tr><td colspan="5" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Loading guests...</td></tr>
    </tbody>
  </table>
</div>

<!-- Add Guest Modal -->
<div id="addGuestModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="hideAddGuestForm()">&times;</span>
    <h2><i class="fas fa-plus"></i> Add New Guest</h2>
    <form id="addGuestForm">
      <div class="form-group">
        <label><i class="fas fa-user"></i> Name:</label>
        <input type="text" id="guestName" required placeholder="Enter guest name">
      </div>
      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Email:</label>
        <input type="email" id="guestEmail" required placeholder="Enter email address">
      </div>
      <div class="form-group">
        <label><i class="fas fa-phone"></i> Phone:</label>
        <input type="tel" id="guestPhone" placeholder="Enter phone number">
      </div>
      <div class="form-group">
        <label><i class="fas fa-map-marker-alt"></i> Address:</label>
        <textarea id="guestAddress" placeholder="Enter address"></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Add Guest
        </button>
        <button type="button" class="btn btn-secondary" onclick="hideAddGuestForm()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let allGuestsData = [];

document.addEventListener('DOMContentLoaded', function() {
  loadGuests();
  
  // Add form submission handler
  document.getElementById('addGuestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    createGuest();
  });
});

function loadGuests() {
  fetch('/api/guests')
    .then(response => response.json())
    .then(data => {
      allGuestsData = data;
      displayGuests(data);
    })
    .catch(error => {
      console.error('Error loading guests:', error);
      document.getElementById('guestsBody').innerHTML = '<tr><td colspan="5" class="loading-row"><i class="fas fa-exclamation-triangle"></i> Error loading guests</td></tr>';
    });
}

function displayGuests(guests) {
  const tbody = document.getElementById('guestsBody');
  tbody.innerHTML = '';
  
  if (guests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="loading-row"><i class="fas fa-info-circle"></i> No guests found</td></tr>';
    return;
  }
  
  guests.forEach(guest => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>${guest.name}</strong></td>
      <td>${guest.email}</td>
      <td>${guest.phone || '-'}</td>
      <td>${guest.address || '-'}</td>
      <td>
        <div class="room-actions">
          <button class="btn btn-secondary" onclick="editGuest(${guest.id})" title="Edit Guest">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-danger" onclick="deleteGuest(${guest.id})" title="Delete Guest">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function filterGuests() {
  const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
  
  let filteredGuests = allGuestsData;
  
  if (searchFilter) {
    filteredGuests = filteredGuests.filter(guest => 
      guest.name.toLowerCase().includes(searchFilter) ||
      guest.email.toLowerCase().includes(searchFilter) ||
      (guest.phone && guest.phone.toLowerCase().includes(searchFilter))
    );
  }
  
  displayGuests(filteredGuests);
}

function createGuest() {
  const data = {
    name: document.getElementById('guestName').value,
    email: document.getElementById('guestEmail').value,
    phone: document.getElementById('guestPhone').value,
    address: document.getElementById('guestAddress').value
  };
  
  fetch('/api/guests', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      hideAddGuestForm();
      loadGuests();
      alert('Guest created successfully!');
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error creating guest:', error);
    alert('Error creating guest');
  });
}

function showAddGuestForm() {
  document.getElementById('addGuestModal').style.display = 'block';
}

function hideAddGuestForm() {
  document.getElementById('addGuestModal').style.display = 'none';
  document.getElementById('addGuestForm').reset();
  
  // Reset modal to add mode
  document.querySelector('#addGuestModal h2').textContent = 'Add New Guest';
  const submitBtn = document.querySelector('#addGuestModal button[type="submit"]');
  submitBtn.textContent = 'Add Guest';
  submitBtn.onclick = function(e) {
    e.preventDefault();
    createGuest();
  };
}

function editGuest(id) {
  // First fetch the guest data
  fetch(`/api/guests`)
    .then(response => response.json())
    .then(guests => {
      const guest = guests.find(g => g.id === id);
      if (guest) {
        document.getElementById('guestName').value = guest.name;
        document.getElementById('guestEmail').value = guest.email;
        document.getElementById('guestPhone').value = guest.phone;
        document.getElementById('guestAddress').value = guest.address;
        
        // Change the modal title and button text
        document.querySelector('#addGuestModal h2').textContent = 'Edit Guest';
        const submitBtn = document.querySelector('#addGuestModal button[type="submit"]');
        submitBtn.textContent = 'Update Guest';
        submitBtn.onclick = function(e) {
          e.preventDefault();
          updateGuest(id);
        };
        
        document.getElementById('addGuestModal').style.display = 'block';
      }
    })
    .catch(error => {
      console.error('Error fetching guest data:', error);
      alert('Error loading guest data');
    });
}

function updateGuest(id) {
  const data = {
    name: document.getElementById('guestName').value,
    email: document.getElementById('guestEmail').value,
    phone: document.getElementById('guestPhone').value,
    address: document.getElementById('guestAddress').value
  };
  
  fetch(`/api/guests/${id}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      hideAddGuestForm();
      loadGuests();
      alert('Guest updated successfully!');
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error updating guest:', error);
    alert('Error updating guest');
  });
}

function deleteGuest(id) {
  if (confirm('Are you sure you want to delete this guest? This action cannot be undone.')) {
    fetch(`/api/guests/${id}`, {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        loadGuests();
        alert('Guest deleted successfully!');
      } else {
        alert('Error: ' + (result.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error deleting guest:', error);
      alert('Error deleting guest');
    });
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('addGuestModal');
  if (event.target == modal) {
    hideAddGuestForm();
  }
}
</script>
{% endblock %}