{% extends 'base.html' %}
{% block content %}
<div class="page-header fade-in">
  <div>
    <h1><i class="fas fa-calendar-check"></i> Reservations Management</h1>
    <p class="page-description">Manage hotel reservations, check-ins, and guest bookings</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" onclick="showAddReservationForm()">
      <i class="fas fa-plus"></i> New Reservation
    </button>
  </div>
</div>

<div class="table-container slide-up">
  <div class="table-header">
    <h2><i class="fas fa-list"></i> All Reservations</h2>
    <div class="table-filters">
      <select id="statusFilter" onchange="filterReservations()">
        <option value="">All Status</option>
        <option value="confirmed">Confirmed</option>
        <option value="pending">Pending</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <input type="text" id="searchFilter" placeholder="Search reservations..." onkeyup="filterReservations()">
    </div>
  </div>
  <table class="data-table" id="reservationsTable">
    <thead>
      <tr>
        <th><i class="fas fa-user"></i> Guest</th>
        <th><i class="fas fa-bed"></i> Room</th>
        <th><i class="fas fa-calendar-plus"></i> Check-in</th>
        <th><i class="fas fa-calendar-minus"></i> Check-out</th>
        <th><i class="fas fa-info-circle"></i> Status</th>
        <th><i class="fas fa-dollar-sign"></i> Total</th>
        <th><i class="fas fa-cogs"></i> Actions</th>
      </tr>
    </thead>
    <tbody id="reservationsBody">
      <tr><td colspan="7" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Loading reservations...</td></tr>
    </tbody>
  </table>
</div>

<!-- Add Reservation Modal -->
<div id="addReservationModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="hideAddReservationForm()">&times;</span>
    <h2><i class="fas fa-plus"></i> New Reservation</h2>
    <form id="addReservationForm">
      <div class="form-group">
        <label><i class="fas fa-user"></i> Guest:</label>
        <select id="reservationGuest" required>
          <option value="">Select Guest</option>
        </select>
      </div>
      <div class="form-group">
        <label><i class="fas fa-bed"></i> Room Type:</label>
        <select id="reservationRoomType" required>
          <option value="">Select Room Type</option>
        </select>
      </div>
      <div class="form-group">
        <label><i class="fas fa-calendar-plus"></i> Check-in Date:</label>
        <input type="date" id="reservationCheckin" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-calendar-minus"></i> Check-out Date:</label>
        <input type="date" id="reservationCheckout" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-users"></i> Number of Guests:</label>
        <input type="number" min="1" id="reservationGuests" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-info-circle"></i> Status:</label>
        <select id="reservationStatus" required>
          <option value="confirmed">Confirmed</option>
          <option value="pending">Pending</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Create Reservation
        </button>
        <button type="button" class="btn btn-secondary" onclick="hideAddReservationForm()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let allReservationsData = [];

document.addEventListener('DOMContentLoaded', function() {
  loadReservations();
  loadGuests();
  loadRoomTypes();
  
  // Add form submission handler
  document.getElementById('addReservationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    createReservation();
  });
});

function loadReservations() {
  fetch('/api/reservations')
    .then(response => response.json())
    .then(data => {
      allReservationsData = data;
      displayReservations(data);
    })
    .catch(error => {
      console.error('Error loading reservations:', error);
      document.getElementById('reservationsBody').innerHTML = '<tr><td colspan="7" class="loading-row"><i class="fas fa-exclamation-triangle"></i> Error loading reservations</td></tr>';
    });
}

function displayReservations(reservations) {
  const tbody = document.getElementById('reservationsBody');
  tbody.innerHTML = '';
  
  if (reservations.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="loading-row"><i class="fas fa-info-circle"></i> No reservations found</td></tr>';
    return;
  }
  
  reservations.forEach(reservation => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>${reservation.guest_name}</strong></td>
      <td>${reservation.room_number}</td>
      <td>${reservation.check_in ? new Date(reservation.check_in).toLocaleDateString() : 'N/A'}</td>
      <td>${reservation.check_out ? new Date(reservation.check_out).toLocaleDateString() : 'N/A'}</td>
      <td><span class="status ${reservation.status}">${reservation.status}</span></td>
      <td><strong>$${reservation.total_price}</strong></td>
      <td>
        <div class="room-actions">
          <button class="btn btn-secondary" onclick="editReservation(${reservation.id})" title="Edit Reservation">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-danger" onclick="deleteReservation(${reservation.id})" title="Delete Reservation">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function filterReservations() {
  const statusFilter = document.getElementById('statusFilter').value;
  const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
  
  let filteredReservations = allReservationsData;
  
  if (statusFilter) {
    filteredReservations = filteredReservations.filter(reservation => reservation.status === statusFilter);
  }
  
  if (searchFilter) {
    filteredReservations = filteredReservations.filter(reservation => 
      reservation.guest_name.toLowerCase().includes(searchFilter) ||
      reservation.room_number.toLowerCase().includes(searchFilter)
    );
  }
  
  displayReservations(filteredReservations);
}

function loadGuests() {
  fetch('/api/guests')
    .then(response => response.json())
    .then(data => {
      const select = document.getElementById('reservationGuest');
      select.innerHTML = '<option value="">Select Guest</option>';
      data.forEach(guest => {
        const option = document.createElement('option');
        option.value = guest.id;
        option.textContent = guest.name;
        select.appendChild(option);
      });
    });
}

function loadRoomTypes() {
  fetch('/api/room-types')
    .then(response => response.json())
    .then(data => {
      const select = document.getElementById('reservationRoomType');
      select.innerHTML = '<option value="">Select Room Type</option>';
      data.forEach(type => {
        const option = document.createElement('option');
        option.value = type.id;
        option.textContent = `${type.name} - $${type.base_price}`;
        select.appendChild(option);
      });
    });
}

function createReservation() {
  const data = {
    guest_id: parseInt(document.getElementById('reservationGuest').value),
    room_type_id: parseInt(document.getElementById('reservationRoomType').value),
    check_in: document.getElementById('reservationCheckin').value,
    check_out: document.getElementById('reservationCheckout').value,
    num_guests: parseInt(document.getElementById('reservationGuests').value),
    status: document.getElementById('reservationStatus').value
  };
  
  fetch('/api/reservations', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      hideAddReservationForm();
      loadReservations();
      alert('Reservation created successfully!');
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error creating reservation:', error);
    alert('Error creating reservation');
  });
}

function showAddReservationForm() {
  document.getElementById('addReservationModal').style.display = 'block';
}

function hideAddReservationForm() {
  document.getElementById('addReservationModal').style.display = 'none';
  document.getElementById('addReservationForm').reset();
  
  // Reset modal to add mode
  document.querySelector('#addReservationModal h2').textContent = 'Add New Reservation';
  const submitBtn = document.querySelector('#addReservationModal button[type="submit"]');
  submitBtn.textContent = 'Add Reservation';
  submitBtn.onclick = function(e) {
    e.preventDefault();
    createReservation();
  };
}

function editReservation(id) {
  // First fetch the reservation data
  fetch(`/api/reservations`)
    .then(response => response.json())
    .then(reservations => {
      const reservation = reservations.find(r => r.id === id);
      if (reservation) {
        // You'll need to fetch guests and room types to populate dropdowns
        Promise.all([
          fetch('/api/guests').then(r => r.json()),
          fetch('/api/room-types').then(r => r.json())
        ]).then(([guests, roomTypes]) => {
          // Populate guest dropdown
          const guestSelect = document.getElementById('reservationGuest');
          guestSelect.innerHTML = '';
          guests.forEach(guest => {
            const option = document.createElement('option');
            option.value = guest.id;
            option.textContent = guest.name;
            if (guest.name === reservation.guest_name) {
              option.selected = true;
            }
            guestSelect.appendChild(option);
          });
          
          // Populate room type dropdown
          const roomTypeSelect = document.getElementById('reservationRoomType');
          roomTypeSelect.innerHTML = '';
          roomTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            roomTypeSelect.appendChild(option);
          });
          
          document.getElementById('reservationCheckIn').value = reservation.check_in;
          document.getElementById('reservationCheckOut').value = reservation.check_out;
          document.getElementById('reservationGuests').value = reservation.num_guests || 1;
          
          // Change the modal title and button text
          document.querySelector('#addReservationModal h2').textContent = 'Edit Reservation';
          const submitBtn = document.querySelector('#addReservationModal button[type="submit"]');
          submitBtn.textContent = 'Update Reservation';
          submitBtn.onclick = function(e) {
            e.preventDefault();
            updateReservation(id);
          };
          
          document.getElementById('addReservationModal').style.display = 'block';
        });
      }
    })
    .catch(error => {
      console.error('Error fetching reservation data:', error);
      alert('Error loading reservation data');
    });
}

function updateReservation(id) {
  const data = {
    guest_id: parseInt(document.getElementById('reservationGuest').value),
    room_type_id: parseInt(document.getElementById('reservationRoomType').value),
    check_in: document.getElementById('reservationCheckIn').value,
    check_out: document.getElementById('reservationCheckOut').value,
    num_guests: parseInt(document.getElementById('reservationGuests').value)
  };
  
  fetch(`/api/reservations/${id}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      hideAddReservationForm();
      loadReservations();
      alert('Reservation updated successfully!');
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error updating reservation:', error);
    alert('Error updating reservation');
  });
}

function deleteReservation(id) {
  if (confirm('Are you sure you want to delete this reservation? This action cannot be undone.')) {
    fetch(`/api/reservations/${id}`, {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        loadReservations();
        alert('Reservation deleted successfully!');
      } else {
        alert('Error: ' + (result.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error deleting reservation:', error);
      alert('Error deleting reservation');
    });
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('addReservationModal');
  if (event.target == modal) {
    hideAddReservationForm();
  }
}
</script>
{% endblock %}