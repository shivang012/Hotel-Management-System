{% extends 'base.html' %}
{% block content %}
<div class="page-header fade-in">
  <div>
    <h1><i class="fas fa-file-invoice-dollar"></i> Billing & Invoices</h1>
    <p class="page-description">Manage invoices, payments, and billing information</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" onclick="showCreateInvoiceForm()">
      <i class="fas fa-plus"></i> Create Invoice
    </button>
  </div>
</div>

<div class="table-container slide-up">
  <div class="table-header">
    <h2><i class="fas fa-list"></i> All Invoices</h2>
    <div class="table-filters">
      <select id="statusFilter" onchange="filterInvoices()">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="paid">Paid</option>
        <option value="overdue">Overdue</option>
      </select>
      <input type="text" id="searchFilter" placeholder="Search invoices..." onkeyup="filterInvoices()">
    </div>
  </div>
  <table class="data-table" id="invoicesTable">
    <thead>
      <tr>
        <th><i class="fas fa-hashtag"></i> Invoice ID</th>
        <th><i class="fas fa-calendar-check"></i> Reservation ID</th>
        <th><i class="fas fa-dollar-sign"></i> Subtotal</th>
        <th><i class="fas fa-percent"></i> Tax</th>
        <th><i class="fas fa-money-bill"></i> Total</th>
        <th><i class="fas fa-info-circle"></i> Status</th>
        <th><i class="fas fa-cogs"></i> Actions</th>
      </tr>
    </thead>
    <tbody id="invoicesBody">
      <tr><td colspan="7" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Loading invoices...</td></tr>
    </tbody>
  </table>
</div>

<!-- Create Invoice Modal -->
<div id="createInvoiceModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="hideCreateInvoiceForm()">&times;</span>
    <h2><i class="fas fa-plus"></i> Create Invoice</h2>
    <form id="createInvoiceForm">
      <div class="form-group">
        <label><i class="fas fa-calendar-check"></i> Reservation ID:</label>
        <input type="number" id="invoiceReservationId" required placeholder="Enter reservation ID">
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Create Invoice
        </button>
        <button type="button" class="btn btn-secondary" onclick="hideCreateInvoiceForm()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- View Invoice Modal -->
<div id="viewInvoiceModal" class="modal" style="display: none;">
  <div class="modal-content large-modal">
    <span class="close" onclick="hideViewInvoiceModal()">&times;</span>
    <h2><i class="fas fa-file-invoice"></i> Invoice Details</h2>
    <div id="invoiceDetails">
      <!-- Invoice details will be populated here -->
    </div>
    <div class="form-actions" style="margin-top: 20px;">
      <button type="button" class="btn btn-primary" onclick="hideViewInvoiceModal()">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
  </div>
</div>

<!-- Add Payment Modal -->
<div id="addPaymentModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="hideAddPaymentModal()">&times;</span>
    <h2>Add Payment</h2>
    <form id="addPaymentForm">
      <label>Amount: <input type="number" step="0.01" id="paymentAmount" required></label>
      <label>Payment Method: 
        <select id="paymentMethod" required>
          <option value="">Select Method</option>
          <option value="cash">Cash</option>
          <option value="credit_card">Credit Card</option>
          <option value="debit_card">Debit Card</option>
          <option value="check">Check</option>
          <option value="bank_transfer">Bank Transfer</option>
        </select>
      </label>
      <label>Reference/Transaction ID: <input type="text" id="paymentReference"></label>
      <button type="submit">Add Payment</button>
      <button type="button" onclick="hideAddPaymentModal()">Cancel</button>
    </form>
  </div>
</div>

<script>
let allInvoicesData = [];
let currentInvoiceId = null;

document.addEventListener('DOMContentLoaded', function() {
  loadInvoices();
  
  // Add payment form submission
  document.getElementById('addPaymentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (currentInvoiceId) {
      const data = {
        amount: parseFloat(document.getElementById('paymentAmount').value),
        method: document.getElementById('paymentMethod').value,
        reference: document.getElementById('paymentReference').value
      };
      
      fetch(`/api/invoices/${currentInvoiceId}/payment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          hideAddPaymentModal();
          loadInvoices();
          alert('Payment added successfully!');
        } else {
          alert('Error: ' + (result.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error adding payment:', error);
        alert('Error adding payment');
      });
    }
  });
});

function loadInvoices() {
  fetch('/api/billing/invoices')
    .then(response => response.json())
    .then(data => {
      allInvoicesData = data;
      displayInvoices(data);
    })
    .catch(error => {
      console.error('Error loading invoices:', error);
      document.getElementById('invoicesBody').innerHTML = '<tr><td colspan="7" class="loading-row"><i class="fas fa-exclamation-triangle"></i> Error loading invoices</td></tr>';
    });
}

function displayInvoices(invoices) {
  const tbody = document.getElementById('invoicesBody');
  tbody.innerHTML = '';
  
  if (invoices.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="loading-row"><i class="fas fa-info-circle"></i> No invoices found</td></tr>';
    return;
  }
  
  invoices.forEach(invoice => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>#${invoice.id}</strong></td>
      <td>${invoice.reservation_id}</td>
      <td>$${invoice.subtotal}</td>
      <td>$${invoice.tax}</td>
      <td><strong>$${invoice.total}</strong></td>
      <td><span class="status ${invoice.status}">${invoice.status}</span></td>
      <td>
        <div class="room-actions">
          <button class="btn btn-secondary" onclick="viewInvoice(${invoice.id})" title="View Invoice">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-success" onclick="addPayment(${invoice.id})" title="Add Payment">
            <i class="fas fa-credit-card"></i>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function filterInvoices() {
  const statusFilter = document.getElementById('statusFilter').value;
  const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
  
  let filteredInvoices = allInvoicesData;
  
  if (statusFilter) {
    filteredInvoices = filteredInvoices.filter(invoice => invoice.status === statusFilter);
  }
  
  if (searchFilter) {
    filteredInvoices = filteredInvoices.filter(invoice => 
      invoice.id.toString().includes(searchFilter) ||
      invoice.reservation_id.toString().includes(searchFilter)
    );
  }
  
  displayInvoices(filteredInvoices);
}

function showCreateInvoiceForm() {
  document.getElementById('createInvoiceModal').style.display = 'block';
}

function hideCreateInvoiceForm() {
  document.getElementById('createInvoiceModal').style.display = 'none';
  document.getElementById('createInvoiceForm').reset();
}

function viewInvoice(id) {
  fetch(`/api/invoices/${id}`)
    .then(response => response.json())
    .then(invoice => {
      const detailsHtml = `
        <div class="invoice-details">
          <h3>Invoice #${invoice.id}</h3>
          <p><strong>Guest:</strong> ${invoice.guest_name}</p>
          <p><strong>Room:</strong> ${invoice.room_number} (${invoice.room_type})</p>
          <p><strong>Check-in:</strong> ${invoice.check_in}</p>
          <p><strong>Check-out:</strong> ${invoice.check_out}</p>
          <p><strong>Subtotal:</strong> $${invoice.subtotal}</p>
          <p><strong>Tax:</strong> $${invoice.tax}</p>
          <p><strong>Total:</strong> $${invoice.total}</p>
          <p><strong>Payment Status:</strong> <span class="status ${invoice.status}">${invoice.status}</span></p>
          <p><strong>Created:</strong> ${invoice.created_at}</p>
          ${invoice.services && invoice.services.length > 0 ? `
            <h4>Services:</h4>
            <ul>
              ${invoice.services.map(service => `<li>${service.name} - $${service.price}</li>`).join('')}
            </ul>
          ` : ''}
        </div>
      `;
      document.getElementById('invoiceDetails').innerHTML = detailsHtml;
      
      // Load and display payments
      fetch(`/api/payments/${id}`)
        .then(response => response.json())
        .then(payments => {
          if (payments.length > 0) {
            const paymentsHtml = `
              <h4>Payments:</h4>
              <table class="data-table">
                <thead>
                  <tr><th>Amount</th><th>Method</th><th>Reference</th><th>Date</th></tr>
                </thead>
                <tbody>
                  ${payments.map(payment => `
                    <tr>
                      <td>$${payment.amount}</td>
                      <td>${payment.method}</td>
                      <td>${payment.reference || 'N/A'}</td>
                      <td>${payment.paid_at}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
            document.getElementById('invoiceDetails').innerHTML += paymentsHtml;
          }
        });
      
      document.getElementById('viewInvoiceModal').style.display = 'block';
    })
    .catch(error => {
      console.error('Error fetching invoice:', error);
      alert('Error loading invoice details');
    });
}

function addPayment(id) {
  currentInvoiceId = id;
  
  // First get invoice details to show remaining amount
  fetch(`/api/invoices/${id}`)
    .then(response => response.json())
    .then(invoice => {
      document.getElementById('paymentAmount').max = invoice.total;
      document.getElementById('paymentAmount').placeholder = `Max: $${invoice.total}`;
      document.getElementById('addPaymentModal').style.display = 'block';
    })
    .catch(error => {
      console.error('Error fetching invoice:', error);
      alert('Error loading invoice details');
    });
}

function hideViewInvoiceModal() {
  document.getElementById('viewInvoiceModal').style.display = 'none';
}

function hideAddPaymentModal() {
  document.getElementById('addPaymentModal').style.display = 'none';
  document.getElementById('addPaymentForm').reset();
  currentInvoiceId = null;
}

// Close modal when clicking outside
window.onclick = function(event) {
  const createModal = document.getElementById('createInvoiceModal');
  const viewModal = document.getElementById('viewInvoiceModal');
  const paymentModal = document.getElementById('addPaymentModal');
  
  if (event.target == createModal) {
    hideCreateInvoiceForm();
  } else if (event.target == viewModal) {
    hideViewInvoiceModal();
  } else if (event.target == paymentModal) {
    hideAddPaymentModal();
  }
}
</script>
{% endblock %}